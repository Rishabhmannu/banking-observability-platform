#!/bin/bash

echo "ğŸ›‘ Stopping Enhanced DDoS Detection & Auto-Baselining System"
echo "==========================================================="

# Navigate to project directory
cd /Users/rishabh/Downloads/Internship\ Related/DDoS_Detection/ddos-detection-system

echo "ğŸ“Š Current system status:"
docker compose ps

echo ""
echo "ğŸ”„ Stopping all services gracefully..."
docker compose stop

echo ""
echo "â³ Waiting for graceful shutdown..."
sleep 15

echo ""
echo "âœ… Verification - Services should be stopped:"
docker compose ps

echo ""
echo "ğŸ” Checking if ports are freed up:"
echo "Port 8080 (Banking API): $(lsof -ti :8080 2>/dev/null | wc -l | tr -d ' ') processes"
echo "Port 5001 (DDoS ML Detection): $(lsof -ti :5001 2>/dev/null | wc -l | tr -d ' ') processes"
echo "Port 5002 (Auto-Baselining): $(lsof -ti :5002 2>/dev/null | wc -l | tr -d ' ') processes"
echo "Port 9090 (Prometheus): $(lsof -ti :9090 2>/dev/null | wc -l | tr -d ' ') processes"
echo "Port 3000 (Grafana): $(lsof -ti :3000 2>/dev/null | wc -l | tr -d ' ') processes"
echo "Port 3306 (MySQL): $(lsof -ti :3306 2>/dev/null | wc -l | tr -d ' ') processes"

echo ""
echo "ğŸ’¾ Data & Configuration Status:"
echo "==============================="
echo "âœ… Banking microservices data: PRESERVED"
echo "âœ… DDoS ML models: PRESERVED" 
echo "âœ… Auto-baselining algorithm data: PRESERVED"
echo "âœ… Threshold recommendations: PRESERVED"
echo "âœ… Grafana dashboards: PRESERVED"
echo "âœ… Prometheus configuration: PRESERVED"
echo "âœ… Alert rules: PRESERVED"
echo "âœ… MySQL banking data: PRESERVED"
echo "âœ… Docker images: PRESERVED"
echo "âœ… Historical metrics: PRESERVED"

echo ""
echo "ğŸ“‚ Preserved Directories:"
echo "========================"
echo "â€¢ ./data/models/ (ML models)"
echo "â€¢ ./data/baselining/ (Auto-baselining data)"
echo "â€¢ ./logs/baselining/ (Auto-baselining logs)"
echo "â€¢ ./config/ (All configurations)"
echo "â€¢ ./prometheus/ (Prometheus config)"

echo ""
echo "ğŸš€ Restart Options:"
echo "=================="
echo "# Quick restart (recommended):"
echo "docker compose up -d"
echo ""
echo "# Using your restart script:"
echo "./restart_system.sh"
echo ""
echo "# Start specific services only:"
echo "docker compose up -d auto-baselining prometheus"
echo ""
echo "# View logs when restarting:"
echo "docker compose up -d && docker compose logs -f"

echo ""
echo "ğŸ§¹ Cleanup Options (if needed):"
echo "==============================="
echo "# Remove containers but keep data:"
echo "docker compose down"
echo ""
echo "# Remove everything including volumes (CAUTION!):"
echo "docker compose down --volumes"
echo ""
echo "# Remove images (if you want to rebuild):"
echo "docker compose down --rmi all"

echo ""
echo "ğŸ” Troubleshooting Commands:"
echo "==========================="
echo "# Check what's still running:"
echo "docker ps"
echo ""
echo "# View recent logs:"
echo "docker compose logs --tail=50 auto-baselining"
echo ""
echo "# Check port usage:"
echo "lsof -i :5002"

echo ""
echo "ğŸ¯ System Features Available on Restart:"
echo "========================================"
echo "ğŸ¦ Banking Microservices (6 services)"
echo "ğŸ¤– DDoS Detection with ML Models"
echo "ğŸ¯ Auto-Baselining with 4 Algorithms:"
echo "   â€¢ Rolling Statistics"
echo "   â€¢ Quantile-based Thresholds"
echo "   â€¢ Isolation Forest (ML)"
echo "   â€¢ Local Outlier Factor (ML)"
echo "ğŸ“Š Prometheus + Grafana Monitoring"
echo "ğŸ”§ Dynamic Threshold Recommendations"

echo ""
echo "ğŸ¯ System stopped successfully! All resources freed up."
echo "ğŸ’¡ All your work is preserved and ready for next restart."
echo "ğŸš€ Both DDoS Detection and Auto-Baselining will resume when restarted!"